<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Scanlines Mobile (Cam√©ra / Image + Palette RVBJ + N√©gatif)</title>
  <style>
    :root{--ui-bg:#111;--gap:10px}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#000;color:#fff;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #app{display:flex;flex-direction:column;min-height:100dvh;align-items:center}
    #stage{width:100%;height:65dvh;display:flex;align-items:center;justify-content:center;background:#000;position:relative}
    canvas{display:block;max-width:100%;height:100%;touch-action:none}
    #controls{width:100%;background:var(--ui-bg);padding:var(--gap);display:flex;flex-wrap:wrap;gap:var(--gap);justify-content:center;position:sticky;bottom:0}
    .group{display:flex;flex-direction:column;align-items:center;gap:6px;background:#1a1a1a;border-radius:12px;padding:8px}
    .row{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center}
    label.sm{font-size:12px;opacity:.85}
    input[type="range"]{width:120px}
    button,.chip{background:#222;color:#fff;border:1px solid #333;border-radius:10px;padding:8px 12px;font-size:14px}
    .chip{display:inline-flex;gap:8px;align-items:center}
    #msg{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#777}
    #overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000;z-index:9999}
    #overlay button{font-size:16px;padding:12px 18px;border-radius:12px}
  </style>
</head>
<body>
<div id="app">
  <div id="stage"><div id="msg">Autorise la cam√©ra ou charge une image</div></div>

  <div id="controls">
    <div class="row" style="width:100%;justify-content:center">
      <span class="chip">
        Source :
        <label><input type="radio" name="src" id="srcCam" checked /> Cam√©ra</label>
        <label><input type="radio" name="src" id="srcImg" /> Image</label>
      </span>

      <button id="switchBtn">üîÑ Switch cam√©ra</button>
      <label class="chip">üì∑ Charger une image<input id="fileInput" type="file" accept="image/*" style="display:none"></label>
      <button id="saveBtn">üì∏ Enregistrer</button>
      <label class="chip"><input type="checkbox" id="animate"> üéûÔ∏è Animation</label>
      <label class="chip"><input type="checkbox" id="negative"> üåì N√©gatif</label>
      <span class="chip">Palette :
        <label><input type="checkbox" id="cR" checked> Rouge</label>
        <label><input type="checkbox" id="cV"> Vert</label>
        <label><input type="checkbox" id="cB"> Bleu</label>
        <label><input type="checkbox" id="cJ"> Jaune</label>
      </span>
      <button id="fsBtn">‚§¢ Plein √©cran</button>
    </div>

    <div class="row">
      <div class="group"><label class="sm">Contraste</label><input id="contrast" type="range" min="0" max="255" value="110"></div>
      <div class="group"><label class="sm">Intensit√©</label><input id="intensity" type="range" min="0" max="20" step="0.1" value="6"></div>
      <div class="group"><label class="sm">Sensibilit√©</label><input id="sensitivity" type="range" min="0.1" max="10" step="0.1" value="1.2"></div>
      <div class="group"><label class="sm">D√©tail</label><input id="detail" type="range" min="1" max="10" value="3"></div>
      <div class="group"><label class="sm">√âpaisseur</label><input id="stroke" type="range" min="0.5" max="8" step="0.1" value="1.3"></div>
      <div class="group"><label class="sm">Rouge</label><input id="red" type="range" min="0" max="1" step="0.01" value="0.2126"></div>
      <div class="group"><label class="sm">Vert</label><input id="green" type="range" min="0" max="1" step="0.01" value="0.7152"></div>
      <div class="group"><label class="sm">Bleu</label><input id="blue" type="range" min="0" max="1" step="0.01" value="0.0722"></div>
      <div class="group"><label class="sm">Points</label><input id="points" type="range" min="0" max="1" step="0.01" value="0"></div>
      <div class="group"><label class="sm">Diagonale</label><input id="diagonal" type="range" min="0" max="1" step="0.01" value="0"></div>
      <div class="group"><label class="sm">Circulaire</label><input id="circular" type="range" min="0" max="1" step="0.01" value="0"></div>
    </div>
  </div>
</div>

<div id="overlay"><button id="startBtn">D√©marrer (plein √©cran)</button></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.dom.min.js"></script>
<script>
  let cam, img;
  let useCamera = true;
  let facing = "environment";
  let animate = false;
  let negative = false;
  let animationOffset = 0;
  let lastTap = 0;
  const ui = {};

  function $(id){ return document.getElementById(id); }

  function startCamera(){
    if (cam) { cam.remove(); cam = null; }
    try {
      cam = createCapture({ video: { facingMode: { exact: facing } }, audio: false });
    } catch(e){
      cam = createCapture({ video: { facingMode: facing }, audio: false });
    }
    cam.elt.setAttribute('playsinline','');
    cam.elt.muted = true;
    cam.size(320, 240);
    cam.hide();
  }

  async function enterFullscreen(){
    const el = document.documentElement;
    const rfs = el.requestFullscreen || el.webkitRequestFullscreen || el.webkitEnterFullscreen;
    if (rfs) {
      try { await rfs.call(el); } catch(e) {}
    }
    screen.orientation && screen.orientation.lock && screen.orientation.lock('portrait').catch(()=>{});
  }

  function saveState(){
    const ids = ['contrast','intensity','sensitivity','detail','stroke','red','green','blue','points','diagonal','circular'];
    const state = { useCamera, facing, animate, negative };
    ids.forEach(id => state[id] = $(id).value);
    ['cR','cV','cB','cJ'].forEach(id => state[id] = $(id).checked);
    localStorage.setItem('scanlinesState', JSON.stringify(state));
  }

  function loadState(){
    try {
      const s = JSON.parse(localStorage.getItem('scanlinesState') || '{}');
      if (!s) return;
      if (s.useCamera !== undefined) { useCamera = s.useCamera; $('srcCam').checked = useCamera; $('srcImg').checked = !useCamera; }
      if (s.facing) facing = s.facing;
      if (s.animate !== undefined) { animate = s.animate; $('animate').checked = animate; }
      if (s.negative !== undefined) { negative = s.negative; $('negative').checked = negative; }
      ['contrast','intensity','sensitivity','detail','stroke','red','green','blue','points','diagonal','circular'].forEach(id => { if (s[id] !== undefined) $(id).value = s[id]; });
      ['cR','cV','cB','cJ'].forEach(id => { if (s[id] !== undefined) $(id).checked = s[id]; });
    } catch(e){}
  }

  function setup(){
    pixelDensity(1);
    const stage = $('stage');
    const c = createCanvas(stage.clientWidth, stage.clientHeight);
    c.parent('stage');
    background(0);

    // Double-tap to switch camera
    stage.addEventListener('touchend', () => {
      const now = Date.now();
      if (now - lastTap < 350) { facing = (facing==='user')?'environment':'user'; if (useCamera) startCamera(); }
      lastTap = now;
    }, {passive:true});

    // Bind UI
    ['contrast','intensity','sensitivity','detail','stroke','red','green','blue','points','diagonal','circular'].forEach(id => {
      ui[id] = $(id);
      ui[id].addEventListener('input', saveState);
    });
    ['cR','cV','cB','cJ','animate','negative','srcCam','srcImg'].forEach(id => $(id).addEventListener('change', saveState));

    $('saveBtn').addEventListener('click', () => saveCanvas('scan_mobile', 'png'));
    $('switchBtn').addEventListener('click', () => { facing = (facing==="user")?"environment":"user"; if (useCamera) startCamera(); });
    $('animate').addEventListener('change', e => animate = e.target.checked);
    $('negative').addEventListener('change', e => negative = e.target.checked);
    $('fsBtn').addEventListener('click', enterFullscreen);

    $('srcCam').addEventListener('change', e => { if(e.target.checked){ useCamera = true; startCamera(); saveState(); }});
    $('srcImg').addEventListener('change', e => { if(e.target.checked){ useCamera = false; if (cam) { cam.remove(); cam=null; } saveState(); }});
    $('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0]; if(!file) return;
      const url = URL.createObjectURL(file);
      loadImage(url, i => { img = i; $('srcImg').checked=true; useCamera=false; $('srcCam').checked=false; $('msg').textContent=""; saveState(); }, err => console.warn(err));
    });

    window.addEventListener('resize', () => { const st = $('stage'); resizeCanvas(st.clientWidth, st.clientHeight); });

    loadState();
    if (useCamera) startCamera();

    // Overlay "tap to start"
    $('startBtn').addEventListener('click', async () => {
      await enterFullscreen();
      if (useCamera) startCamera();
      document.getElementById('overlay').style.display='none';
    }, {passive:false});
  }

  function draw(){
    background(negative ? 255 : 0);
    strokeWeight(parseFloat(ui.stroke.value));
    noFill();

    let src = null;
    if (useCamera && cam && cam.width>0) {
      $('msg').textContent="";
      cam.loadPixels();
      src = cam;
    } else if (!useCamera && img) {
      src = img;
    } else {
      return;
    }

    const detail = Math.max(1, parseInt(ui.detail.value));
    const rw = parseFloat(ui.red.value), gw = parseFloat(ui.green.value), bw = parseFloat(ui.blue.value);
    const contrast = parseFloat(ui.contrast.value);
    const intensity = parseFloat(ui.intensity.value);
    const sens = parseFloat(ui.sensitivity.value);
    const points = parseFloat(ui.points.value);
    const diag = parseFloat(ui.diagonal.value);
    const circ = parseFloat(ui.circular.value);

    if (animate) animationOffset += 0.05;

    const srcW = src.width, srcH = src.height;

    for (let x = 1; x < srcW - 1; x += detail) {
      if (points <= 0.5) beginShape();
      for (let y = 1; y < srcH - 1; y++) {
        const br = weightedAt(src, x, y, rw, gw, bw);
        const dx = weightedAt(src, x+1, y, rw, gw, bw) - weightedAt(src, x-1, y, rw, gw, bw);
        const dy = weightedAt(src, x, y+1, rw, gw, bw) - weightedAt(src, x, y-1, rw, gw, bw);
        const curve = (dx*dx + dy*dy) * sens;
        const offset = map(curve, 0, 255*255, -intensity, intensity);

        const baseX = map(x, 0, srcW, 0, width);
        const baseY = map(y, 0, srcH, 0, height);
        const diagOffset = diag * (y - srcH/2) * 0.3;
        const circOffset = circ * Math.sin(dist(x, y, srcW/2, srcH/2) * 0.1 + animationOffset) * 5.0;

        const xDraw = baseX + offset + diagOffset;
        const yDraw = baseY + offset + circOffset;

        setStrokeColor(br, negative);

        if (br > contrast) {
          if (points > 0.5) point(xDraw, yDraw);
          else vertex(xDraw, yDraw);
        }
      }
      if (points <= 0.5) endShape();
    }
  }

  function paletteColors(){
    const pick = [];
    if ($('cR').checked) pick.push(color(255,40,40));
    if ($('cV').checked) pick.push(color(40,220,120));
    if ($('cB').checked) pick.push(color(40,140,255));
    if ($('cJ').checked) pick.push(color(255,210,40));
    return pick;
  }

  function setStrokeColor(br, negativeMode){
    const cols = paletteColors();
    if (cols.length === 0) {
      stroke(negativeMode ? 0 : 255);
      return;
    }
    const idx = Math.min(cols.length - 1, Math.floor(map(br, 0, 255, 0, cols.length)));
    const col = cols[idx];
    if (!negativeMode) stroke(col);
    else stroke(255 - red(col), 255 - green(col), 255 - blue(col));
  }

  function weightedAt(src, x, y, rw, gw, bw){
    const c = src.get(x, y);
    return red(c)*rw + green(c)*gw + blue(c)*bw;
  }
</script>
</body>
</html>
